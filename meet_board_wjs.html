<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Meeting Schedule</title>

    <style>
        /* Palatte Definitions */
        :root {
            --dark-bg: #141414;
            --earthtone-primary: #a0522d; /* Sienna Brown (Left Panel) */
            --earthtone-secondary: #c2b280; /* Desert Khaki/Gold (Bottom Right) */
            --earthtone-yellow-light: #f1c40f; 
            --earthtone-yellow-dark: #b8860b;
            --white-panel: #ffffff;
            --text-dark: #1e1e1e;
            --text-light: #f5f5f5;
            --border-radius-size: 15px;
            --gutter: 7px;
        }

        /* Base and Widescreen Body */
        body.dark-background {
            margin: 0; padding: 0; height: 100vh; display: flex;
            justify-content: center; align-items: center;
            background-color: var(--dark-bg); color: var(--text-light);
            font-family: Arial, sans-serif; overflow: hidden;
        }

        /* Widescreen Aspect Ratio Container (16:9) */
        .widescreen-container {
            width: 90vw; max-height: 50.625vw; min-height: 550px; 
            background-color: var(--dark-bg); border-radius: var(--border-radius-size);
            padding: var(--gutter);
        }

        /* Core Geometric Layout (1 large box left, 3 small boxes right) */
        .geometric-layout {
            height: 100%; display: grid; grid-template-columns: 1fr 1fr; 
            gap: var(--gutter);
        }

        /* General Card Styling */
        .card {
            padding: var(--gutter); border-radius: var(--border-radius-size); 
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.4);
        }

        /* LEFT HALF: Schedule Panel */
        .large-panel {
            grid-row: 1 / span 1; background-color: var(--earthtone-primary);
            display: block; text-align: left; overflow-y: auto; 
        }
        .schedule-list {
            list-style: none; padding: 0; margin: 5px 0 0 0;
        }
        .schedule-list li {
            display: flex; justify-content: space-between; align-items: center;
            padding: 5px 0; border-bottom: 1px dashed rgba(255, 255, 255, 0.1);
            font-size: 1.0em;
        }
        .time-stamp {
            font-weight: bold; color: var(--earthtone-accent); min-width: 60px;
        }
        .activity-text {
            flex-grow: 1; padding-left: var(--gutter);
        }

        /* RIGHT HALF: FIXED GRID STRUCTURE */
        .right-column {
            display: grid; grid-template-rows: 1fr auto; gap: var(--gutter);
        }
        .top-right-panels {
            display: grid; grid-template-columns: 1fr 1fr; gap: var(--gutter);
        }

        /* Top Right Pane 1: Activity Log (White) */
        #activity-log {
            background-color: var(--earthtone-yellow-light); color: var(--text-dark);
        }

        /* Top Right Pane 2: Graphic Placeholder (White, NO TEXT) */
        #unit-crest {
            background-color: var(--white-panel); color: var(--text-dark);
            padding: var(--gutter); display: flex; justify-content: center;
            align-items: center; flex-direction: column; 
        }
		
        /* Bottom Right Box */
        .wide-right-bottom {
            background-color: var(--earthtone-secondary); color: var(--text-dark);
        }

        /* Text and Title Styles */
        h2, h3 {
            border-bottom: 2px solid rgba(255, 255, 255, 0.1); padding-bottom: 5px; 
            color: var(--text-light); margin-top: 0; margin-bottom: 5px;
        }
        .large-panel h2 { color: var(--text-light); border-bottom-color: rgba(255, 255, 255, 0.2); }
        #activity-log h3, .wide-right-bottom h3 {
             color: var(--text-dark); border-bottom-color: rgba(0, 0, 0, 0.1);
        }
        
        /* List Formatting (Right Panels) */
        #activity-list, #action-items ol { padding-left: 10px; }
        #activity-list li, #action-items li {
            margin-bottom: 5px; line-height: 1.3; font-size: 0.9em;
            color: var(--text-dark);
        }
    </style>
</head>
<body class="dark-background">
    
    <main class="widescreen-container">
        <div class="geometric-layout">
            
            <section id="kpi-panel" class="card large-panel">
                <h2>Meeting Schedule (1900 - 2145)</h2>
                
                <ul class="schedule-list" id="schedule-list">
                    <li><span class="time-stamp">Loading...</span> <span class="activity-text">Waiting for data feed.</span></li>
                </ul>

            </section>

            <div class="right-column">
                
                <div class="top-right-panels">
                    <section id="activity-log" class="card small-panel">
                        <center></center><h1>CADETS</h1><hr>
                        <ul id="activity-list">
                            <li>**Loading:** Awaiting activity records...</li>
                        </ul>
                        <p>
		             <h2><strong id="soonestMondayDate"></strong></h2> <br>
                             (<span id="mondayOccurrence"></span>)
                        </p></center>
                    </section>

                    <section id="unit-crest" class="card small-panel">
                            <img href="sq64-patch.jpg" height=250 width=200></image>
                    </section>
                </div>

                <section id="action-items" class="card small-panel wide-right-bottom">
                    <h3>&#x25A0; Next Action Items (Q4 Focus)</h3>
                    <ol id="action-items-list">
                        <li>Loading action items...</li>
                    </ol>
                </section>
            </div>

        </div>
    </main>

<script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- CONFIGURATION ---
            // NOTE: The Public Key is used instead of the Sheet ID for published documents.
            const PUBLIC_KEY = '2PACX-1vSjrqT9-Nby0RiTzaUd89s1QMKPsHaXEK4QjM-P2vUBafInr6rP1sVG4p0rjZSz0N7hrRXkeMDc3CKy';
            const BASE_URL = `https://docs.google.com/spreadsheets/d/e/${PUBLIC_KEY}/pub?`;

            // Data source mappings: [GID, Column Count]
            // We use the GIDs from the previous session, updating the first one with the GID you just sent.
            const DATA_SOURCES = {
                // Assuming this GID (1034767002) is the Schedule tab
                schedule: { gid: '1034767002', colCount: 2 },
                activity: { gid: '1138531778', colCount: 2 }, 
                actions: { gid: '1970258165', colCount: 1 }    
            };

            // --- Panel Element References ---
            const scheduleList = document.getElementById('schedule-list');
            const activityList = document.getElementById('activity-list');
            const actionList = document.getElementById('action-items-list');

            // --- Public Feed Helper Function ---
            const buildPublicFeedUrl = (source) => {
                const { gid } = DATA_SOURCES[source];
                // Use the output=csv format for reliable client-side fetching
                return `${BASE_URL}gid=${gid}&single=true&output=csv`;
            };

            // --- Universal Fetch and CSV Parser Function ---
            const fetchAndRenderCSV = async (source, listElement, transformFunction) => {
                const endpoint = buildPublicFeedUrl(source);
                const { colCount } = DATA_SOURCES[source];
                try {
                    listElement.innerHTML = `<li>Fetching data for ${source} via public feed...</li>`;

                    const response = await fetch(endpoint);
                    if (!response.ok) {
                        throw new Error(`Failed to fetch data. Status: ${response.status}`);
                    }
                    
                    const csvText = await response.text();
                    
                    // Simple CSV parsing: split lines, then split cells by comma.
                    // We skip the header row (index 0).
                    const rows = csvText.split('\n')
                        .slice(1) 
                        .map(line => line.trim())
                        .filter(line => line) // Remove empty lines
                        .map(line => {
                            // Simple split by comma, works for basic text.
                            // NOTE: Will fail if cell data contains unescaped commas.
                            return line.split(',').slice(0, colCount).map(cell => cell.trim().replace(/^"|"$/g, ''));
                        });

                    
                    // Clear previous content
                    listElement.innerHTML = ''; 

                    // Apply the specific rendering function
                    transformFunction(rows, listElement);

                } catch (error) {
                    console.error(`Data Load Error for ${source}:`, error);
                    listElement.innerHTML = `<li>ERROR loading ${source} data: ${error.message}</li>`;
                }
            };

            // --- 1. Schedule Panel Renderer ---
            // Expected Row Data: [Time (Col 0), Text (Col 1)]
            const renderSchedule = (rows, element) => {
                if (rows.length === 0) {
                    element.innerHTML = '<li>No schedule items found.</li>';
                    return;
                }
                rows.forEach(item => {
                    const time = item[0] || 'N/A';
                    const text = item[1] || 'No description';
                    const li = document.createElement('li');
                    li.innerHTML = `<span class="time-stamp">${time}</span> <span class="activity-text">${text}</span>`;
                    element.appendChild(li);
                });
            };

            // --- 2. Activity Log Renderer ---
            // Expected Row Data: [Time (Col 0), Text (Col 1)]
            const renderActivity = (rows, element) => {
                if (rows.length === 0) {
                    element.innerHTML = '<li>No recent activity found.</li>';
                    return;
                }
                rows.forEach(item => {
                    const time = item[0] || 'N/A';
                    const text = item[1] || 'No description';
                    const li = document.createElement('li');
                    li.innerHTML = `<li>**${time}:** ${text}</li>`;
                    element.appendChild(li);
                });
            };

            // --- 3. Action Items Renderer ---
            // Expected Row Data: [Text (Col 0)]
            const renderActions = (rows, element) => {
                if (rows.length === 0) {
                    element.innerHTML = '<li>No open action items found.</li>';
                    return;
                }
                // The Action Items panel uses an <ol> (ordered list)
                rows.forEach(item => {
                    const text = item[0] || 'No action item text';
                    const li = document.createElement('li');
                    li.textContent = text;
                    element.appendChild(li);
                });
            };

            // --- Execute all fetches on load ---
            fetchAndRenderCSV('schedule', scheduleList, renderSchedule);
            fetchAndRenderCSV('activity', activityList, renderActivity);
            fetchAndRenderCSV('actions', actionList, renderActions);

        });

        // Helper function to format the occurrence number (e.g., 1 -> 1st, 2 -> 2nd)
        function formatOrdinal(n) {
            const s = ["th", "st", "nd", "rd"];
            const v = n % 100;
            return n + (s[(v - 20) % 10] || s[v] || s[0]);
        }

        // Main function to calculate and display the date and occurrence
        function getSoonestMondayExtended() {
            // Array of three-letter month abbreviations (0=Jan, 1=Feb, etc.)
            const monthNames = [
                "JAN", "FEB", "MAR", "APR", "MAY", "JUN", 
                "JUL", "AUG", "SEP", "OCT", "NOV", "DEC"
            ];

            // 1. Calculate the date of the soonest Monday
            const today = new Date();
            const currentDay = today.getDay(); // 0 = Sunday, 1 = Monday
            
            // Calculate how many days we need to advance to reach Monday (Day 1)
            const daysUntilMonday = (1 - currentDay + 7) % 7; 
            
            const soonestMonday = new Date(today);
            soonestMonday.setDate(today.getDate() + daysUntilMonday);

            // 2. Determine the occurrence number (e.g., 1st, 2nd, 3rd)
            
            // The occurrence number is determined by which week of the month the date falls in.
            // We find the week number by taking the day of the month, subtracting 1, and dividing by 7.
            const dayOfMonth = soonestMonday.getDate();
            const occurrenceNumber = Math.floor((dayOfMonth - 1) / 7) + 1;
            
            // Format the number to include "st", "nd", "rd", or "th"
            const formattedOccurrence = formatOrdinal(occurrenceNumber) + " Monday";

            // 3. Format the date as 'DD MMM YYYY' (US Military)
            const day = soonestMonday.getDate().toString().padStart(2, '0');
            const monthIndex = soonestMonday.getMonth();
            const month = monthNames[monthIndex];
            const year = soonestMonday.getFullYear();

            const formattedDate = `${day} ${month} ${year}`;

            // 4. Output the results to the HTML elements
            document.getElementById('soonestMondayDate').textContent = formattedDate;
            document.getElementById('mondayOccurrence').textContent = formattedOccurrence;
        }

        // Execute the function when the script loads
        getSoonestMondayExtended();

    </script>
</body>
</html>
